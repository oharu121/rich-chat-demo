# Development Notes - December 27, 2025

## Backend Modularization

### Changes Made

Restructured the backend from a flat structure to a proper `app/` package pattern:

**Before:**
```
backend/
├── main.py
├── agents/
└── models/
```

**After:**
```
backend/
├── app/
│   ├── main.py          # FastAPI entry point
│   ├── core/
│   │   └── registry.py  # Agent registry
│   ├── routers/
│   │   ├── chat.py      # /api/chat endpoint
│   │   ├── health.py    # /api/health endpoint
│   │   └── agents.py    # /api/agents endpoint
│   ├── agents/          # Agent implementations
│   └── models/          # Pydantic schemas
├── Dockerfile
└── pyproject.toml
```

### Why This Structure?

1. **Separation of Concerns** - Each router handles a single API concern
2. **Scalability** - Easy to add new routers, agents, or services
3. **Testability** - Individual components can be tested in isolation
4. **Standard Pattern** - Follows common FastAPI project structure conventions

### Key Files Created

- `app/core/registry.py` - Centralized agent management with `init_agents()`, `get_agent()`, `clear_agents()`
- `app/routers/chat.py` - SSE streaming chat endpoint
- `app/routers/health.py` - Health check endpoint
- `app/routers/agents.py` - List available agents endpoint

## Docker Permission Fix for Hugging Face Spaces

### Problem

When deploying to HF Spaces, got error:
```
error: failed to write to file `/app/uv.lock`: Permission denied (os error 13)
```

### Root Cause

The Dockerfile was:
1. Installing dependencies as root
2. Creating user after copying files
3. Running `uv sync` after switching to non-root user, but the directory was owned by root

### Solution

Reordered Dockerfile operations:

```dockerfile
# 1. Create user FIRST
RUN useradd -m -u 1000 user

# 2. Install uv as root (needs pip access)
RUN pip install uv

# 3. Set working directory and give ownership to user
WORKDIR /code
RUN chown user:user /code

# 4. Switch to user BEFORE copying files
USER user

# 5. Copy files with correct ownership
COPY --chown=user:user pyproject.toml uv.lock* ./

# 6. Now uv sync can write to the directory
RUN uv sync --frozen --no-dev

# 7. Copy rest of application
COPY --chown=user:user . .
```

### Key Lessons

1. **Order matters in Dockerfiles** - Create users before copying files that need user ownership
2. **Use `--chown` with COPY** - Ensures files are owned by the correct user
3. **HF Spaces requires non-root** - Must run as user with UID 1000
4. **`uv sync` writes files** - Needs write permission to create/update `uv.lock`

## Updated References

Changed `main:app` to `app.main:app` in:
- `backend/Dockerfile` (CMD)
- `package.json` (dev:backend script)
- `backend/README.md` (running instructions)
- `backend/pyproject.toml` (packages = ["app"])

## Vitest Setup for Frontend

Added vitest with coverage for CI pipeline:

- `frontend/vitest.config.ts` - Test configuration with v8 coverage
- `frontend/vitest.setup.ts` - DOM mocks (matchMedia, ResizeObserver, etc.)
- `frontend/__tests__/useSlashCommands.test.ts` - 14 tests for slash command hook

Scripts added to `frontend/package.json`:
- `test` - Run tests once
- `test:watch` - Watch mode
- `test:coverage` - Generate coverage report
