# Dev Notes - 2025-12-26

## Project: Slash Command Chat Interface

Implemented a chat interface ported from `rag-demo` project, focused on exploring slash commands for agent routing.

### What Was Built

#### Backend (Python FastAPI)

| File | Purpose |
|------|---------|
| `backend/main.py` | FastAPI app with SSE streaming endpoints |
| `backend/models/schemas.py` | Pydantic models (AgentType, ChatRequest, etc.) |
| `backend/agents/base.py` | Abstract BaseAgent class |
| `backend/agents/default_agent.py` | General chat agent |
| `backend/agents/code_agent.py` | Code assistance agent |
| `backend/agents/search_agent.py` | Search/lookup agent |
| `backend/agents/explain_agent.py` | Explanation agent |

**API Endpoints:**
- `POST /api/chat` - SSE streaming chat with agent routing
- `GET /api/health` - Health check
- `GET /api/agents` - List available agents

#### Frontend (Next.js 16 + React 19)

| File | Purpose |
|------|---------|
| `frontend/lib/types.ts` | TypeScript interfaces |
| `frontend/lib/constants.ts` | UI text, API config, slash commands |
| `frontend/lib/api.ts` | SSE streaming client (async generator) |
| `frontend/hooks/useChat.ts` | Chat state management |
| `frontend/hooks/useSlashCommands.ts` | Command parsing & autocomplete |
| `frontend/app/components/ChatInterface.tsx` | Main chat UI |
| `frontend/app/components/ChatInput.tsx` | Input with slash command support |
| `frontend/app/components/MessageBubble.tsx` | Message rendering with avatar |
| `frontend/app/components/SlashCommandMenu.tsx` | Autocomplete dropdown |
| `frontend/app/components/AgentBadge.tsx` | Agent indicator badge |
| `frontend/app/components/MayaAvatar.tsx` | Animated avatar (idling/speaking/thinking) |
| `frontend/app/components/LoadingSpinner.tsx` | Loading indicator |
| `frontend/public/avatars/` | Maya GIF animations (copied from rag-demo) |

### Features Implemented

1. **Slash Command System**
   - `/code` - Code assistance and generation
   - `/search` - Web search and information lookup
   - `/explain` - Explain concepts in detail
   - `/help` - Show available commands

2. **Autocomplete Menu**
   - Shows when typing `/`
   - Keyboard navigation (Arrow Up/Down, Tab, Enter, Escape)
   - Filters commands as you type

3. **SSE Streaming**
   - Real-time token streaming from backend
   - Agent info sent before response starts
   - Processing time tracked

4. **UI Features**
   - Animated Maya avatar with state transitions
   - Agent badges on messages
   - Premium glass morphism styling
   - Responsive design

### What Was Removed (from rag-demo)

- Document management (drawer, upload, preview, chips)
- Dataset selector and chunking strategies
- Evaluation system and scoring
- Source citations and chunk viewer
- Japanese text (converted to English)

### Running the Project

**Backend:**
```bash
cd backend
uv run uvicorn main:app --reload --port 8000
```

**Frontend:**
```bash
cd frontend
npm run dev
```

### Next Steps

1. **Integrate Real LLM** - Update agent `stream_response()` methods to call OpenAI/Anthropic APIs
2. **Add More Agents** - Create specialized agents for different use cases
3. **Persist History** - Add conversation storage
4. **Agent Context** - Allow agents to have memory and context

### Design Decisions

- **Python backend over Next.js API routes**: Better for AI/ML ecosystem, agent frameworks, and LLM SDKs
- **SSE over WebSocket**: Simpler for unidirectional streaming, works well with async generators
- **Separate agents**: Each agent in its own file for easy extension and customization

---

## Lessons Learned

### Async Generator Type Annotations in Python

**Problem:** Pyright reported type errors when using `async def` with `-> AsyncGenerator[str, None]` return type in an abstract method:

```
error: Method "stream_response" overrides class "BaseAgent" in an incompatible manner
  Return type mismatch: base method returns type "CoroutineType[Any, Any, AsyncGenerator[str, None]]"
```

**Root Cause:** When you declare:
```python
@abstractmethod
async def stream_response(...) -> AsyncGenerator[str, None]:
    pass
```

The `async def` keyword makes this a coroutine that *returns* an AsyncGenerator, not an async generator itself. The type signature says "this is a coroutine returning AsyncGenerator" but implementations using `async def` with `yield` are actual async generators.

**Solution:** Remove `async` from the abstract method and use `AsyncIterator`:

```python
from collections.abc import AsyncIterator

@abstractmethod
def stream_response(
    self,
    message: str,
    history: list[dict],
) -> AsyncIterator[str]:
    ...
```

The implementations can still use `async def` with `yield`:
```python
async def stream_response(self, message: str, history: list[dict]) -> AsyncIterator[str]:
    yield "token"
    await asyncio.sleep(0.01)
    yield "another token"
```

**Key Insight:** For abstract methods that will be implemented as async generators:
- Use `def` (not `async def`) in the abstract signature
- Use `AsyncIterator[T]` as the return type (from `collections.abc`)
- Implementations can use `async def` with `yield` - they'll correctly satisfy the `AsyncIterator` type

---

### Backend Project Structure Decision

**Problem:** Uvicorn failed to start with `ModuleNotFoundError: No module named 'app'`

The root `package.json` had:
```json
"dev:backend": "cd backend && uv run uvicorn app.main:app --reload --port 7860"
```

But the actual structure is:
```
backend/
├── main.py          # FastAPI app at root, not in app/ subfolder
├── agents/
└── models/
```

**Options Considered:**

1. **Create `app/` folder** - More conventional FastAPI structure, cleaner imports
2. **Keep flat structure** - Simpler, modules already organized (`agents/`, `models/`)

**Decision:** Keep the flat structure.

**Rationale:**
- The project already has modular organization with `agents/` and `models/` folders
- Adding `app/` subfolder would require moving files, updating imports, and adding `__init__.py` files
- For a demo/exploration project, the current structure is sufficient
- Don't over-engineer for hypothetical future needs - can refactor later if needed

**Fix:** Changed `app.main:app` to `main:app` in package.json:
```json
"dev:backend": "cd backend && uv run uvicorn main:app --reload --port 7860"
```
